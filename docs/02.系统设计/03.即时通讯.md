---
title: 即时通讯
date: 2023-08-03 21:11:13
permalink: /pages/52d41b/
---
## 系统架构


## 消息可靠性
上行消息ack，下行消息也要ack。
客户端发送消息时起一个定时器，一段时间没有收到2个ack就重发。重发一定次数后还是失败就进行红点标记，让用户点击再次重发，此时消息id要重新生成。

## 消息顺序性
**单聊**
客户端A发送消息携带一个本地消息id（单调递增），客户端B根据消息中的本地消息id进行排序。**按照发送端的顺序进行排序。**

**群聊**
同一个群聊的消息id生成路由到同一个service，**通过服务端来保证消息顺序**。

## 消息幂等性
由于ack超时重传机制，可能重复发送消息，如何处理？
客户端发送消息，携带客户端id，服务器根据客户端id去重，防止重复插入数据。
客户端根据消息id去重。
